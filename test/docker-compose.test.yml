version: "3"

services:

  smtp4dev:
    image: rnwood/smtp4dev:v3
    restart: always
    ports:
      - '5001:80'
      - '25:25'
      - '143:143'
    volumes:
        - smtp4dev-data:/smtp4dev
    environment:
      - ServerOptions__HostName=smtp4dev
      - ServerOptions__TlsMode=StartTls

  # Backend
  backend:
    environment:
      SES_EMAIL_HOST: smtp4dev
      SES_EMAIL_PORT: 25
      SES_SMTP_USERNAME: someuser
      SES_SMTP_PASSWORD: somepassword
      DB_URI: /app/data/test_db.db
      HOSTNAME: something
      PORT: someport
    volumes:
      - ./backend/app:/app
      - ./test/resources/data:/app/data
    depends_on:
      - nn_api
      - smtp4dev


  nn_api:
    ports:
      - 8000:8000
    volumes:
      - ./test/resources/data:/mutcompute_2020/data
      - ./nets/api:/mutcompute_2020/api
    environment:
      PYTHONUNBUFFERED: 1
      DB_URI: /mutcompute_2020/data/test_db.db
      DB_NN_TABLE: NN_Query
      AWS_ACCESS_KEY_ID: 
      AWS_SECRET_ACCESS_KEY: 
      JOB_QUEUE_URL: https://sqs.us-east-1.amazonaws.com/444461107311/predictor-test.fifo
      AWS_REGION: us-east-1


  # #Queue/Worker Processes
  celery:
    container_name: celery
    build:
      context: ./nets
      dockerfile: Dockerfile
    image: mutcompute:api
    volumes: 
      - ./test/resources/data:/mutcompute_2020/data
    environment:
      PYTHONUNBUFFERED: 1
      SES_EMAIL_HOST: smtp4dev
      SES_EMAIL_PORT: 25
      SES_SMTP_USERNAME: someuser
      SES_SMTP_PASSWORD: somepassword
      DB_URI: /mutcompute_2020/data/test_db.db
      DB_NN_TABLE: NN_Query
    depends_on:
      - redis
      - smtp4dev

  predictor:
    volumes:
      - ./predictors/predictor:/predictor
      - ./test/resources/data:/mutcompute_2020/data
    command: python3 ./main.py
    environment:
      AWS_ACCESS_KEY_ID: 
      AWS_SECRET_ACCESS_KEY: 
      JOB_QUEUE_URL: https://sqs.us-east-1.amazonaws.com/444461107311/predictor-test.fifo
      AWS_REGION: us-east-1
      MODEL_BUCKET: mutcompute-models
      MODEL_LIST: testmodel.tar.gz
      PIPELINE_FILE: pipeline.json
      SES_EMAIL_HOST: smtp4dev
      SES_EMAIL_PORT: 25
      SES_SMTP_USERNAME: someuser
      SES_SMTP_PASSWORD: somepassword
      DB_URI: /mutcompute_2020/data/test_db.db
      DB_NN_TABLE: NN_Query
      TF_CPP_MIN_LOG_LEVEL: 3
    depends_on:
      - smtp4dev

volumes:
  smtp4dev-data: